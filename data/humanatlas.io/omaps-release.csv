SPARQL-QUERY: queryStr=PREFIX dcat: <http://www.w3.org/ns/dcat#>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX prov: <http://www.w3.org/ns/prov#>
PREFIX schema: <http://schema.org/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX ccf: <http://purl.org/ccf/>
PREFIX obo: <http://purl.obolibrary.org/obo/>
PREFIX owl: <http://www.w3.org/2002/07/owl#>
PREFIX xsd:<http://www.w3.org/2001/XMLSchema#>
PREFIX HRA: <https://purl.humanatlas.io/collection/hra>
PREFIX has_characterizing_biomarker_set: <http://purl.obolibrary.org/obo/RO_0015004>
PREFIX body: <http://purl.obolibrary.org/obo/UBERON_0013702>

SELECT ?omapId (?graphAndVersion as ?url)
  ?organ ?tissuePreservationMethod ?imagingMethod
  ?csv ?xlsx ('TODO: Ellen fills in' as ?representativeDataset)
  ?as ?ct ?bp
WHERE {
"  hint:Query hint:analytic ""true"" ."

  GRAPH HRA: {
    HRA: prov:hadMember ?graphAndVersion .
  }
  GRAPH <https://lod.humanatlas.io> {
    ?graphAndVersion a dcat:Dataset ;
      schema:name ?name ;
      schema:additionalType ?type ;
      schema:version ?table_version ;
    .
    FILTER(?type = 'omap' && !CONTAINS(?name, '-crosswalk'))
    BIND(IRI(CONCAT('https://purl.humanatlas.io/omap/', ?name)) as ?purl)
    BIND(IRI(CONCAT(STR(?graphAndVersion), '#raw-data')) as ?rawData)
    BIND(REPLACE(?name, '-', ' ') as ?Organ)
    BIND(CONCAT('OMAP-', STRBEFORE(?name, '-')) as ?omapId)
    BIND(xsd:integer(STRBEFORE(?name, '-')) as ?omapOrder)

    ?graphAndVersion prov:wasDerivedFrom [
      dcat:distribution [
        dcat:downloadURL ?csv ;
        dcat:mediaType ?mediaType ;
      ]
    ] .
    FILTER(?mediaType = 'text/csv')

    ?graphAndVersion prov:wasDerivedFrom [
      dcat:distribution [
        dcat:downloadURL ?xlsx ;
        dcat:mediaType ?xlsxMediaType ;
      ]
    ] .
    FILTER(?xlsxMediaType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
  }

  GRAPH ?purl {
    [] a ccf:MultiplexedAntibodyBasedImagingExperiment ;
      ccf:sample_organ [ rdfs:label ?organ ] ;
      ccf:tissue_preservation ?tissuePreservationMethod ;
      ccf:method ?imagingMethod ;
    .
  }

  OPTIONAL {
    SELECT ?purl (COUNT(DISTINCT(?term)) as ?bp)
    WHERE {
      GRAPH ?purl {
        [] ccf:detects ?term .
      }
    }
    GROUP BY ?purl
  }

  # AS and CT are provided by SMEs at this time.
  # OPTIONAL {
  #   SELECT ?purl (COUNT(DISTINCT(?as_)) as ?as) (COUNT(DISTINCT(?term)) as ?ct)
  #   WHERE {
  #     GRAPH ?purl {
  #       [] ccf:detects ?biomarker .

  #       [] a ccf:MultiplexedAntibodyBasedImagingExperiment ;
  #         ccf:sample_organ [ rdfs:label ?organ ] ;
  #     }
  #     GRAPH ?purl2 {
  #       ?term ccf:ccf_asctb_type ?asctb_type ;
  #         ccf:ccf_biomarker_type ?bm_type .
  #       FILTER(?asctb_type = 'BM' && ?bm_type = 'protein')

  #       ?term rdfs:subClassOf [
  #         owl:onProperty has_characterizing_biomarker_set: ;
  #         owl:someValuesFrom [ owl:intersectionOf ?bn3 ]] .
  #       ?bn3 rdf:rest*/rdf:first [
  #         owl:onProperty ccf:has_marker_component ;
  #         owl:someValuesFrom ?biomarker
  #       ] .

  #       ?term ccf:ccf_located_in ?as_ .
  #       ?as_ ccf:ccf_part_of ?organ .

  #       hint:SubQuery hint:runOnce true;
  #     }
  #     FILTER(CONTAINS(STR(?purl2), '/asct-b/'))
  #   }
  #   GROUP BY ?purl
  # }
}
ORDER BY ?omapOrder

java.util.concurrent.ExecutionException: java.util.concurrent.ExecutionException: java.lang.RuntimeException: java.lang.RuntimeException: addr=-2826978 : cause=java.lang.OutOfMemoryError: Direct buffer memory
	at java.util.concurrent.FutureTask.report(FutureTask.java:122)
	at java.util.concurrent.FutureTask.get(FutureTask.java:206)
	at com.bigdata.rdf.sail.webapp.BigdataServlet.submitApiTask(BigdataServlet.java:292)
	at com.bigdata.rdf.sail.webapp.QueryServlet.doSparqlQuery(QueryServlet.java:678)
	at com.bigdata.rdf.sail.webapp.QueryServlet.doPost(QueryServlet.java:275)
	at com.bigdata.rdf.sail.webapp.RESTServlet.doPost(RESTServlet.java:269)
	at com.bigdata.rdf.sail.webapp.MultiTenancyServlet.doPost(MultiTenancyServlet.java:195)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:707)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)
	at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:865)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1655)
	at org.eclipse.jetty.servlets.CrossOriginFilter.handle(CrossOriginFilter.java:248)
	at org.eclipse.jetty.servlets.CrossOriginFilter.doFilter(CrossOriginFilter.java:211)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1634)
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:533)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)
	at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)
	at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)
	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)
	at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1340)
	at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)
	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)
	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)
	at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1242)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)
	at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:220)
	at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)
	at org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)
	at org.eclipse.jetty.server.Server.handle(Server.java:503)
	at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)
	at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)
	at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)
	at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)
	at org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)
	at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)
	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)
	at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)
	at java.lang.Thread.run(Thread.java:748)
Caused by: java.util.concurrent.ExecutionException: java.lang.RuntimeException: java.lang.RuntimeException: addr=-2826978 : cause=java.lang.OutOfMemoryError: Direct buffer memory
	at java.util.concurrent.FutureTask.report(FutureTask.java:122)
	at java.util.concurrent.FutureTask.get(FutureTask.java:192)
	at com.bigdata.rdf.sail.webapp.QueryServlet$SparqlQueryTask.call(QueryServlet.java:889)
	at com.bigdata.rdf.sail.webapp.QueryServlet$SparqlQueryTask.call(QueryServlet.java:695)
	at com.bigdata.rdf.task.ApiTaskForIndexManager.call(ApiTaskForIndexManager.java:68)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	... 1 more
Caused by: java.lang.RuntimeException: java.lang.RuntimeException: addr=-2826978 : cause=java.lang.OutOfMemoryError: Direct buffer memory
	at com.bigdata.rdf.lexicon.LexiconRelation.addTerms(LexiconRelation.java:2059)
	at com.bigdata.rdf.lexicon.LexiconRelation.addTerms(LexiconRelation.java:1897)
	at com.bigdata.rdf.sparql.ast.eval.ASTDeferredIVResolution.resolveIVs(ASTDeferredIVResolution.java:1157)
	at com.bigdata.rdf.sparql.ast.eval.ASTDeferredIVResolution.resolve(ASTDeferredIVResolution.java:462)
	at com.bigdata.rdf.sparql.ast.eval.ASTDeferredIVResolution.resolveQuery(ASTDeferredIVResolution.java:268)
	at com.bigdata.rdf.sparql.ast.eval.ASTEvalHelper.optimizeQuery(ASTEvalHelper.java:408)
	at com.bigdata.rdf.sparql.ast.eval.ASTEvalHelper.evaluateTupleQuery(ASTEvalHelper.java:211)
	at com.bigdata.rdf.sail.BigdataSailTupleQuery.evaluate(BigdataSailTupleQuery.java:79)
	at com.bigdata.rdf.sail.BigdataSailTupleQuery.evaluate(BigdataSailTupleQuery.java:61)
	at org.openrdf.repository.sail.SailTupleQuery.evaluate(SailTupleQuery.java:75)
	at com.bigdata.rdf.sail.webapp.BigdataRDFContext$TupleQueryTask.doQuery(BigdataRDFContext.java:1713)
	at com.bigdata.rdf.sail.webapp.BigdataRDFContext$AbstractQueryTask.innerCall(BigdataRDFContext.java:1569)
	at com.bigdata.rdf.sail.webapp.BigdataRDFContext$AbstractQueryTask.call(BigdataRDFContext.java:1534)
	at com.bigdata.rdf.sail.webapp.BigdataRDFContext$AbstractQueryTask.call(BigdataRDFContext.java:747)
	... 4 more
Caused by: java.lang.RuntimeException: addr=-2826978 : cause=java.lang.OutOfMemoryError: Direct buffer memory
	at com.bigdata.rwstore.RWStore.getData(RWStore.java:2097)
	at com.bigdata.journal.RWStrategy.readFromLocalStore(RWStrategy.java:732)
	at com.bigdata.journal.RWStrategy.read(RWStrategy.java:155)
	at com.bigdata.journal.AbstractJournal.read(AbstractJournal.java:4307)
	at com.bigdata.btree.AbstractBTree.readNodeOrLeaf(AbstractBTree.java:4533)
	at com.bigdata.btree.Node._getChild(Node.java:2746)
	at com.bigdata.btree.AbstractBTree$1.compute(AbstractBTree.java:377)
	at com.bigdata.btree.AbstractBTree$1.compute(AbstractBTree.java:360)
	at com.bigdata.util.concurrent.Memoizer$1.call(Memoizer.java:77)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at com.bigdata.util.concurrent.Memoizer.compute(Memoizer.java:92)
	at com.bigdata.btree.AbstractBTree.loadChild(AbstractBTree.java:546)
	at com.bigdata.btree.Node.getChild(Node.java:2644)
	at com.bigdata.btree.Node.lookup(Node.java:938)
	at com.bigdata.btree.Node.lookup(Node.java:940)
	at com.bigdata.btree.AbstractBTree.lookup(AbstractBTree.java:2455)
	at com.bigdata.btree.AbstractBTree.lookup(AbstractBTree.java:2383)
	at com.bigdata.rdf.lexicon.Term2IdWriteProc.applyOnce(Term2IdWriteProc.java:370)
	at com.bigdata.rdf.lexicon.Term2IdWriteProc.applyOnce(Term2IdWriteProc.java:117)
	at com.bigdata.btree.proc.AbstractKeyArrayIndexProcedure.apply(AbstractKeyArrayIndexProcedure.java:381)
	at com.bigdata.btree.AbstractBTree.submit(AbstractBTree.java:3296)
	at com.bigdata.rdf.lexicon.Term2IdWriteTask.call(Term2IdWriteTask.java:239)
	at com.bigdata.rdf.lexicon.LexiconRelation.addTerms(LexiconRelation.java:2055)
	... 17 more
Caused by: java.lang.OutOfMemoryError: Direct buffer memory
	at java.nio.Bits.reserveMemory(Bits.java:695)
	at java.nio.DirectByteBuffer.<init>(DirectByteBuffer.java:123)
	at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:311)
	at sun.nio.ch.Util.getTemporaryDirectBuffer(Util.java:241)
	at sun.nio.ch.IOUtil.read(IOUtil.java:195)
	at sun.nio.ch.FileChannelImpl.readInternal(FileChannelImpl.java:735)
	at sun.nio.ch.FileChannelImpl.read(FileChannelImpl.java:721)
	at com.bigdata.io.FileChannelUtility.readAll(FileChannelUtility.java:192)
	at com.bigdata.rwstore.RWStore.readRaw(RWStore.java:6740)
	at com.bigdata.io.writecache.WriteCacheService._readFromLocalDiskIntoNewHeapByteBuffer(WriteCacheService.java:3774)
	at com.bigdata.io.writecache.WriteCacheService._getRecord(WriteCacheService.java:3598)
	at com.bigdata.io.writecache.WriteCacheService.access$2500(WriteCacheService.java:200)
	at com.bigdata.io.writecache.WriteCacheService$1.compute(WriteCacheService.java:3435)
	at com.bigdata.io.writecache.WriteCacheService$1.compute(WriteCacheService.java:3419)
	at com.bigdata.util.concurrent.Memoizer$1.call(Memoizer.java:77)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at com.bigdata.util.concurrent.Memoizer.compute(Memoizer.java:92)
	at com.bigdata.io.writecache.WriteCacheService.loadRecord(WriteCacheService.java:3540)
	at com.bigdata.io.writecache.WriteCacheService.read(WriteCacheService.java:3259)
	at com.bigdata.rwstore.RWStore.getData(RWStore.java:2088)
	... 39 more
